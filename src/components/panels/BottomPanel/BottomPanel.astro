---
import { Icon } from 'astro-icon/components'
import MOTDContent from './MOTDContent.astro'
import ActiveTrackContent from './ActiveTrackContent.astro'
---

<div 
    class="bottom-panel isopen" 
    x-data="bottomPanelArrows()" 
    x-init="init()"
>
    <!-- Close button -->
    <button class="bottom-panel-close-button" title="Close info panel">
        <Icon name="fa7-solid:xmark" class="icon" />
    </button>

    <!-- OVERLAY ARROWS (desktop only) -->
    <div class="arrow-overlay left" x-cloak x-show="showLeft" @click="scrollLeft"></div>
    <div class="arrow-overlay right" x-cloak x-show="showRight" @click="scrollRight"></div>

    <div class="bottom-panel-content">

        <!-- MOTD MODE -->
        <template x-if="!$store.tracks.activeTrackId">
            <div class="panel-mode-wrapper">
                <div class="bottom-panel-title is-size-6 has-text-weight-bold has-background-light p-2">
                    What's new...
                </div>

                <div class="card-container">
                    <div class="card-row">
                        <MOTDContent />
                    </div>
                </div>
            </div>
        </template>

        <!-- ACTIVE TRACK MODE -->
        <template x-if="$store.tracks.activeTrackId">
            <div class="panel-mode-wrapper">

                <div 
                    class="bottom-panel-title is-size-6 has-text-weight-bold has-background-light py-2 pl-2 pr-5 is-flex is-align-items-center"
                >
                    <!-- Reset button (styled like your app buttons) -->
                    <button 
                        class="reset-btn mr-2"
                        @click="$store.tracks.resetAnimation()"
                        title="Reset to track"
                    >
                        <Icon name="fa7-solid:crosshairs" />
                    </button>

                    <!-- Track name -->
                    <span
                        x-text="
                            $store.tracks.items[$store.tracks.activeTrackId].details.trackName +
                            ($store.tracks.items[$store.tracks.activeTrackId].details.trackFav ? ' ✭' : '')
                        "
                    ></span>
                </div>

                <div class="card-container">
                    <div class="card-row">
                        <ActiveTrackContent />
                    </div>
                </div>

            </div>
        </template>

    </div>
</div>

<script is:inline>
    function bottomPanelArrows() {
        return {
            showLeft: false,
            showRight: false,
            scroller: null,

            init() {
                this.$nextTick(() => this.bindScroller())
                this.$watch('$store.tracks.activeTrackId', () => this.bindScroller())
            },

            bindScroller() {
                const scroller = [...this.$root.querySelectorAll('.card-container')]
                    .find(el => el.offsetParent !== null)

                if (!scroller) {
                    this.$nextTick(() => this.bindScroller())
                    return
                }

                this.scroller = scroller

                const update = () => {
                    const max = scroller.scrollWidth - scroller.clientWidth
                    this.showLeft = scroller.scrollLeft > 0
                    this.showRight = scroller.scrollLeft < max - 1
                }

                scroller.addEventListener('scroll', update)
                window.addEventListener('resize', update)

                requestAnimationFrame(update)
            },

            scrollLeft() {
                const el = this.scroller
                if (!el) return

                const amount = el.clientWidth * 0.9

                if (window.env.isIOS()) {
                    el.scrollLeft -= amount
                } else {
                    el.scrollBy({ left: -amount, behavior: 'smooth' })
                }
            },

            scrollRight() {
                const el = this.scroller
                if (!el) return

                const amount = el.clientWidth * 0.9

                if (window.env.isIOS()) {
                    el.scrollLeft += amount
                } else {
                    el.scrollBy({ left: amount, behavior: 'smooth' })
                }
            }
        }
    }
</script>

<style>
    .bottom-panel {
        background: #f5f5f5;
        overflow: hidden;
        height: 14rem;
        max-height: 14rem;
        position: relative;
        z-index: var(--z-panels);
        transition: max-height .3s ease;
    }

    .bottom-panel:not(.isopen) {
        max-height: 0;
    }

    /* Safari/iPad compositing bug: force title into its own GPU layer so thumbnails don’t draw over it */
    .bottom-panel-title {
        position: relative;
        z-index: 2;
        transform: translateZ(0); /* force GPU compositing */
        will-change: transform;   /* hint to Safari */
    }

    .bottom-panel-content {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
    }

    .panel-mode-wrapper {
        display: flex;
        flex-direction: column;
        flex: 1 1 0;
        min-height: 0;
    }

    .card-container {
        flex: 1 1 0;
        min-height: 0;

        overflow-x: auto;
        overflow-y: hidden;

        padding-left: var(--side-panel-width);
        padding-right: var(--ui-space);
        box-sizing: border-box;

        scroll-snap-type: x mandatory;
        scroll-padding-left: 1rem;

        display: flex;
        align-items: stretch;
    }

    .card-row {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: stretch;
        width: max-content;
        margin: 0 auto;
        min-height: 0;
    }

    /* Overlay arrows */
    .arrow-overlay {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 32px;
        height: 32px;

        display: flex;
        align-items: center;
        justify-content: center;

        border-radius: 50%;
        background: rgba(154, 154, 154, 0.8);
        color: white;

        pointer-events: auto;
        z-index: var(--z-arrow-overlays);
        transition: opacity .15s ease;
    }

    .arrow-overlay.left {
        left: var(--ui-space);
    }

    .arrow-overlay.right {
        right: var(--ui-space);
    }

    .arrow-overlay::after {
        content: '‹';
        font-size: 1.25rem;
        line-height: 1;
    }

    .arrow-overlay.right::after {
        content: '›';
    }

    @media (max-width: 768px) {
        .arrow-overlay {
            display: none;
        }

        .bottom-panel-content {
            overflow-y: auto;
            overflow-x: hidden;
        }

        .card-container {
            display: block;
            overflow-x: hidden;
            overflow-y: visible;
            height: auto;
            scroll-snap-type: none;
            padding-left: 0;
            padding-right: 0;
        }

        .card-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
            width: 100%;
            margin: 0;
        }
    }

    .reset-btn {
        width: 24px;
        height: 24px;
        padding: 0;
        border: none;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
        border-radius: 4px;
    }

    .reset-btn svg {
        width: 20px;
        height: 20px;
    }
</style>
