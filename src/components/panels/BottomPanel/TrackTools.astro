---
import '../../../styles/vendor/bulma-switch-control/main.min.css' 
import { Icon } from 'astro-icon/components'
---
<div class="track-card p-3" x-data="trackTools()">

    <div class="track-tools-title mb-3">Track tools</div>

    <!-- Checkbox row -->
    <div class="switch-row mb-3">
        <label class="switch is-rounded">
            <input
                type="checkbox"
                x-model="showThumbnails"
                @change="toggleThumbnails"
            >
            <span class="check is-info"></span>
            <span class="control-label">Thumbnails</span>
        </label>
    </div>


    <div class="control-grid">

        <!-- Transport row: Slower / Play-Pause / Stop / Faster -->
        <div class="control-row">
            <button class="anim-btn" @click="slower()" title="Slower">
                <Icon name="fa7-solid:backward" />
            </button>

            <button
                class="anim-btn"
                x-bind:class="{ blink: isActive }"
                @click="togglePlay()"
                title="Play / Pause"
            >
                <template x-if="isPlaying">
                    <Icon name="fa7-solid:pause" />
                </template>
                <template x-if="!isPlaying">
                    <Icon name="fa7-solid:play" />
                </template>
            </button>

            <button class="anim-btn" @click="reset()" title="Stop">
                <Icon name="fa7-solid:stop" />
            </button>

            <button class="anim-btn" @click="faster()" title="Faster">
                <Icon name="fa7-solid:forward" />
            </button>
        </div>

        <!-- Exit row -->
        <div></div>
        <div class="center">
            <button class="exit-btn" @click="exitTrack()" title="Exit track">
                Exit track
            </button>
        </div>
        <div></div>

    </div>

</div>

<script is:inline>
    function trackTools() {
        return {
            isPlaying: false,
            isActive: false,
            showThumbnails: true,   // default ON

            init() {
                this.$watch('$store.tracks.animationFinished', value => {
                    if (value) {
                        this.isPlaying = false
                        this.isActive = false
                        this.$store.tracks.showMarkers()
                        this.$store.tracks.animationFinished = false
                    }
                })
                this.$watch('$store.tracks.active', trackId => {
                    map.clearMapThumbnails()

                    if (!trackId) return

                    const track = this.$store.tracks.items[trackId]
                    if (!track?.geotags) return

                    map.renderMapThumbnails(track.geotags.geoTags)

                    if (!this.showThumbnails) {
                        map.hideMapThumbnails()
                    }
                })
            },

            toggleThumbnails() {
                if (this.showThumbnails) {
                    map.showMapThumbnails()
                } else {
                    map.hideMapThumbnails()
                }
            },

            togglePlay() {
                if (!this.isActive) {
                    this.isActive = true
                    this.$store.tracks.hideMarkers()
                }

                this.isPlaying = !this.isPlaying
                this.$store.tracks.animate(this.isPlaying)
            },

            faster() {
                if (this.isPlaying) this.$store.tracks.increaseSpeed()
            },

            slower() {
                if (this.isPlaying) this.$store.tracks.decreaseSpeed()
            },

            reset() {
                this.isPlaying = false
                this.isActive = false
                this.$store.tracks.resetAnimation()
            },

            exitTrack() {
                this.isPlaying = false
                this.isActive = false
                this.$store.tracks.exitActiveTrack()
            }
        }
    }
</script>

<style>
    .track-tools-title {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
        text-align: center;
    }

    .switch-row {
        display: flex;
        justify-content: center;
    }

    .switch-row .switch {
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
    }

    /*.switch-row .switch .control-label {
        margin-left: 0.4rem;
    } */

    .checkbox-row .checkbox input {
        margin-right: 6px;
    }

    .control-grid {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        row-gap: 0.75rem;
        justify-items: center;
    }

    .control-row {
        grid-column: 1 / 4;
        display: flex;
        justify-content: center;
        gap: 0.4rem;
    }

    .anim-btn {
        width: 26px;
        height: 26px;
        padding: 0;
        border: none;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
        border-radius: 4px;
    }

    .anim-btn svg {
        width: 16px;
        height: 16px;
    }

    .exit-btn {
        font-size: 0.75rem;
        font-weight: 500;
        padding: 4px 10px;
        border: none;
        background: #fff;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
        border-radius: 4px;
        white-space: nowrap;
    }

    .blink {
        animation: blinker 1.5s linear infinite;
    }

    @keyframes blinker {
        50% {
            opacity: 0.4;
        }
    }
</style>
