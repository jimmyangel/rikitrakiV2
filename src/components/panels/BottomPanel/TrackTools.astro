---
import '../../../styles/vendor/bulma-switch-control/main.min.css' 
import { Icon } from 'astro-icon/components'
---
<div class="track-card p-3" x-data="trackTools()">

    <div class="track-tools-title mb-2">Track tools</div>

    <!-- Checkbox row -->
    <div class="switch-row mb-3">
        <label :disabled="!hasGeotaggedPhotos()" class="switch is-rounded">
            <input
                type="checkbox"
                x-model="showThumbnails"
                @change="toggleThumbnails"
                :disabled="!hasGeotaggedPhotos()"
            >
            <span class="check is-info"></span>
            <span class="control-label">Thumbnails</span>
        </label>
    </div>


    <div class="control-grid">

        <!-- Transport row: Slower / Play-Pause / Stop / Faster -->
        <div class="control-row">
            <button class="anim-btn" @click="slower()" title="Slower">
                <Icon name="fa7-solid:backward" />
            </button>

            <button
                class="anim-btn"
                x-bind:class="{ blink: $store.tracks.isTrackInPlay }"
                @click="togglePlay()"
                title="Play / Pause"
            >
                <template x-if="isPlaying">
                    <Icon name="fa7-solid:pause" />
                </template>
                <template x-if="!isPlaying">
                    <Icon name="fa7-solid:play" />
                </template>
            </button>

            <button class="anim-btn" @click="reset()" title="Stop/Reset">
                <template x-if="$store.tracks.isTrackInPlay">
                    <Icon name="fa7-solid:stop" />
                </template>
                <template x-if="!$store.tracks.isTrackInPlay">
                    <Icon name="fa7-solid:bullseye" />
                </template>
            </button>

            <button class="anim-btn" @click="faster()" title="Faster">
                <Icon name="fa7-solid:forward" />
            </button>
        </div>

        <!-- Exit row -->
        <div></div>
        <div class="center">
            <button class="exit-btn" @click="exitTrack()" title="Exit track">
                Exit track
            </button>
        </div>
        <div></div>

        <!-- Download row -->
        <div></div>
        <div class="center">
            <button class="exit-btn" @click="downloadGPX()" title="Download GPX">
                Download
            </button>
        </div>
        <div></div>

    </div>

</div>

<script is:inline>
    function trackTools() {
        return {
            isPlaying: false,
            showThumbnails: true,   // default ON

            init() {
                this.$watch('$store.tracks.animationFinished', value => {
                    if (value) {
                        // Local truth first
                        this.isPlaying = false

                        // Mirror to store
                        this.$store.tracks.isTrackInPlay = false

                        this.$store.tracks.showMarkers()
                        this.$store.tracks.animationFinished = false
                    }
                })
            },

            toggleThumbnails() {
                if (this.showThumbnails) {
                    map.showMapThumbnails()
                } else {
                    map.hideMapThumbnails()
                }
            },

            hasGeotaggedPhotos() {
                const store = this.$store.tracks
                if (!store) return false

                const activeTrackId = store.activeTrackId
                if (activeTrackId == null) return false

                const track = store.items[activeTrackId]
                if (!track) return false

                return (track?.geotags?.geoTags?.trackPhotos ?? [])
                    .some(p => p.picLatLng)
            },

            togglePlay() {
                // Flip local state
                this.isPlaying = !this.isPlaying

                if (this.isPlaying) {
                    // We are entering play/resume mode
                    this.$store.tracks.isTrackInPlay = true
                    this.$store.tracks.hideMarkers()
                }

                // Drive animation with the local truth
                this.$store.tracks.animate(this.isPlaying)
            },


            faster() {
                if (this.isPlaying) {
                    this.$store.tracks.increaseSpeed()
                }
            },

            slower() {
                if (this.isPlaying) {
                    this.$store.tracks.decreaseSpeed()
                }
            },

            reset() {
                // Local truth
                this.isPlaying = false

                // Mirror to store
                this.$store.tracks.isTrackInPlay = false

                this.$store.tracks.resetAnimation()
            },

            exitTrack() {
                // Local truth
                this.isPlaying = false

                // Mirror to store
                this.$store.tracks.isTrackInPlay = false

                this.$store.tracks.exitActiveTrack({ fromHistory: false })
            },

            downloadGPX() {
                const trackId = this.$store.tracks.activeTrackId
                if (!trackId) return

                const track = this.$store.tracks.items[trackId]
                if (!track || !track.gpxBlob) return

                const blob = track.gpxBlob
                const url = URL.createObjectURL(blob)

                const originalName = track.details?.trackGPX || `track-${trackId}.gpx`

                const a = document.createElement('a')
                a.href = url
                a.download = originalName
                a.click()

                URL.revokeObjectURL(url)
            }
        }
    }
</script>

<style>
    .track-tools-title {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
        text-align: center;
    }

    .switch-row {
        display: flex;
        justify-content: center;
    }

    .switch-row .switch {
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
    }

    .checkbox-row .checkbox input {
        margin-right: 6px;
    }

    .control-grid {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        row-gap: 0.75rem;
        justify-items: center;
    }

    .control-row {
        grid-column: 1 / 4;
        display: flex;
        justify-content: center;
        gap: 0.4rem;
    }

    .anim-btn {
        width: 26px;
        height: 26px;
        padding: 0;
        border: none;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
        border-radius: 4px;
    }

    .anim-btn svg {
        width: 16px;
        height: 16px;
    }

    .exit-btn {
        font-size: 0.75rem;
        font-weight: 500;
        padding: 4px 10px;
        border: none;
        background: #fff;
        cursor: pointer;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
        border-radius: 4px;
        white-space: nowrap;
    }

    .blink {
        animation: blinker 1.5s linear infinite;
    }

    @keyframes blinker {
        50% {
            opacity: 0.4;
        }
    }
</style>
