---
import Thumbnail from './Thumbnail.astro';
---

<template x-data="trackThumbnails(true)" x-for="(p, i) in photos" :key="$store.tracks.active + '-' + i">
	<Thumbnail />
</template>


<script is:inline>
    function trackThumbnails(isActiveTrackMode = true) {
        return {
			isActiveTrackMode,
            get photos() {
                return this.$store.tracks.items[this.$store.tracks.active]
                    ?.geotags?.geoTags?.trackPhotos ?? []
            },

            getImage(p) {
                return p?.picThumbBlob
                    ? `data:image/jpeg;base64,${p.picThumbBlob}`
                    : ''
            },

            getLabel(p, i) {
                return p?.picCaption || `Photo ${i}`
            },

			getFullUrl(p, i) {
				const trackId = this.$store.tracks.activeTrackId
				if (!p || !trackId) return null
				const picPointer = p.picIndex ?? i
				return `${constants.APIV2_BASE_URL}/tracks/${trackId}/picture/${picPointer}`
			},

			init() {
				const refresh = () => {
					console.log('here is init',this.$store.tracks.activeTrackId )
					if (!this.isActiveTrackMode) return

					this.$nextTick(() => {
						if (this.lightbox) this.lightbox.destroy()

						this.lightbox = GLightbox({
							selector: '.glightbox',
							touchNavigation: true,
							loop: false,
						})
					})
				}
				refresh()

				this.$watch('$store.tracks.activeTrackId', refresh)

				// Open the slides from the map thumbnails
				window.addEventListener('map-thumb-click', (e) => { 
					const index = e.detail.index
					if (!this.lightbox) return 
					this.lightbox.openAt(index)
				})
			}

        }
    }
</script>
