---
import Thumbnail from './Thumbnail.astro';
---

<template x-data="trackThumbnails(true)" x-for="(p, i) in photos" :key="$store.tracks.activeTrackId + '-' + i">
	<Thumbnail />
</template>


<script is:inline>
    function trackThumbnails(isActiveTrackMode = true) {
        return {
			isActiveTrackMode,
            get photos() {
                return this.$store.tracks.items[this.$store.tracks.activeTrackId]
                    ?.geotags?.geoTags?.trackPhotos ?? []
            },

            getImage(p) {
                return p?.picThumbBlob
                    ? `data:image/jpeg;base64,${p.picThumbBlob}`
                    : ''
            },

            getLabel(p, i) {
                return p?.picCaption || `Photo ${i}`
            },

			getFullUrl(p, i) {
				const trackId = this.$store.tracks.activeTrackId
				if (!p || !trackId) return null
				const picPointer = p.picIndex ?? i
				return `${constants.APIV2_BASE_URL}/tracks/${trackId}/picture/${picPointer}`
			},

			init() {
				const refresh = () => {
					if (!this.isActiveTrackMode) return

					this.$nextTick(() => {
						// Destroy old instance
						if (this.lightbox) this.lightbox.destroy()

						// Create new instance
						this.lightbox = GLightbox({
							selector: '.glightbox',
							touchNavigation: true,
							loop: false,
						})

						// Make it globally accessible so renderMapThumbnails() can reload it
						window.lightbox = this.lightbox
					})
				}

				// Initial load
				refresh()

				// Rebuild lightbox when track changes
				this.$watch('$store.tracks.activeTrackId', refresh)
			}


        }
    }
</script>
