---
import '../../styles/vendor/bulma-switch-control/main.min.css'
import ErrorMessage from '../widgets/ErrorMessage.astro'
import InfoMessage from '../widgets/InfoMessage.astro'
import { Icon } from 'astro-icon/components'
---

<div x-data>
	<div class="modal modal-top" :class="{ 'is-active': $store.ui.showUploadTrackModal }">

        <div class="modal-background"
             @click="$store.ui.showUploadTrackModal = false"></div>

        <div class="modal-card" x-data="uploadTrackModal">

            <!-- HEADER -->
            <header class="modal-card-head">
                <div class="modal-card-title">
                    <p class="is-size-5 mb-2">Upload a Track</p>
                    <p class="is-size-6 mr-2">
                        Provide track information and optional photos…
                    </p>
                </div>
                <button class="delete" aria-label="close"
                        @click="$store.ui.showUploadTrackModal = false"></button>
            </header>

            <!-- BODY -->
            <section class="modal-card-body">

                <!-- TABS -->
                <div class="tabs is-boxed">
                    <ul>
                        <li :class="{ 'is-active': tab === 'info' }">
                            <a @click="tab = 'info'">Info</a>
                        </li>
                        <li :class="{ 'is-active': tab === 'photos' }">
                            <a @click="tab = 'photos'">Photos</a>
                        </li>
                    </ul>
                </div>

				<!-- INFO TAB -->
				<div x-show="tab === 'info'">
					<div>

						<!-- GPX FILE -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">GPX file</label>
							<div class="field-body">
								<div class="field">
									<div class="control">
										<input class="input"
											type="file"
											accept=".gpx"
											@change="selectGpxFile($event)"
											:class="{ 'is-danger': errorField === 'gpxFile' }">
									</div>
									<p class="help is-size-7">Up to 4MB</p>

									<template x-if="trackRegionTags">
										<p class="help mt-1">
											Detected region:
											<span x-text="trackRegionTags.join(', ')"></span>
										</p>
									</template>
								</div>
							</div>
						</div>

						<!-- TRACK NAME -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Name</label>
							<div class="field-body">
								<div class="field">
									<div class="control">
										<input class="input"
											type="text"
											maxlength="200"
											placeholder="Track name"
											x-model="trackName"
											:class="{ 'is-danger': errorField === 'trackName' }">
									</div>
								</div>
							</div>
						</div>

						<!-- DESCRIPTION -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Description</label>
							<div class="field-body">
								<div class="field">
									<div class="control">
										<textarea class="textarea"
												rows="5"
												maxlength="5000"
												placeholder="Track description"
												x-model="trackDescription"
												:class="{ 'is-danger': errorField === 'trackDescription' }"></textarea>
									</div>
								</div>
							</div>
						</div>

						<!-- FAVORITE -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Favorite?</label>
							<div class="field-body">
								<div class="field">
									<label class="switch is-rounded">
										<input type="checkbox" x-model="trackFav">
										<span class="check is-info"></span>
									</label>
								</div>
							</div>
						</div>

						<!-- DIFFICULTY -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Difficulty</label>
							<div class="field-body">
								<div class="field">
									<div class="buttons has-addons">
										<button
											class="button"
											:class="{ 'has-background-grey-light is-selected': trackLevel === 'Easy' }"
											@click="trackLevel = 'Easy'">
											Easy
										</button>

										<button
											class="button"
											:class="{ 'has-background-grey-light is-selected': trackLevel === 'Moderate' }"
											@click="trackLevel = 'Moderate'">
											Moderate
										</button>

										<button
											class="button"
											:class="{ 'has-background-grey-light is-selected': trackLevel === 'Difficult' }"
											@click="trackLevel = 'Difficult'">
											Difficult
										</button>
									</div>
								</div>
							</div>
						</div>

						<!-- ACTIVITY -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Activity</label>
							<div class="field-body">
								<div class="field">
									<div class="control">
										<div class="select">
											<select x-model="trackType">
												<option>Hiking</option>
												<option>Biking</option>
												<option>Boating</option>
												<option>Offroad</option>
												<option>Motorcycling</option>
												<option>Flying</option>
												<option>Skiing</option>
												<option>Snowshoeing</option>
												<option>Getting There</option>
											</select>
										</div>
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>

                <!-- PHOTOS TAB -->
                <div x-show="tab === 'photos'">
                    <div>

                        <!-- PHOTO UPLOAD ROW -->
                        <div class="field">
                            <div class="control is-flex is-flex-wrap-wrap is-align-items-center">

                                <p class="mr-3 mb-2">Up to 8 JPEG images</p>

                                <div class="mr-4 mb-2">
                                    <input type="file"
                                        multiple
                                        accept="image/*"
                                        class="is-hidden"
                                        x-ref="photoInput"
                                        @change="selectPhotos($event)">
                                    <button class="button" @click="$refs.photoInput.click()">
                                        <Icon name="fa7-solid:image" class="is-size-4"/>
                                    </button>
                                </div>

                                <p class="mr-4 mb-2">Images larger than 1MB will be resized</p>

                                <div class="is-flex is-align-items-center mb-2">
                                    <label class="label mr-2 mb-0">Time offset (hrs)</label>
                                    <input class="input"
                                        style="width: 6rem;"
                                        type="number"
                                        min="-14"
                                        max="14"
                                        step="0.5"
                                        x-model="timeOffset">
                                </div>

                            </div>
                        </div>

                        <!-- PHOTO GRID -->
                        <div class="columns is-multiline" id="track-photos-container">
                            <template x-for="(photo, idx) in trackPhotos" :key="idx">
                                <div class="column is-one-quarter"
                                    draggable="true"
                                    @dragstart="startDrag(idx)"
                                    @dragover.prevent
                                    @drop="dropOn(idx)">

                                    <input class="input is-small mb-2"
                                        type="text"
                                        maxlength="200"
                                        placeholder="Caption"
                                        x-model="photo.picCaption">

                                    <figure class="image is-4by3 mb-1" style="overflow:hidden;">
                                        <img :src="photoMeta[idx].preview"
                                            style="width:100%; height:100%; object-fit:cover;">
                                    </figure>
                                </div>
                            </template>
                        </div>

                    </div>
				</div>

				<div class="field is-horizontal mt-4">
					<div class="field-label"></div>
					<div class="field-body">
						<div class="field">
							<div class="control">
								<button class="button"
										:disabled="$store.ui.uploading"
										@click="upload()">
									Upload
								</button>
							</div>
						</div>
					</div>
				</div>

            </section>

            <!-- FOOTER -->
            <footer class="modal-card-foot py-2">
                <div class="is-fullwidth" style="height: 68px;">

                    <template x-if="$store.ui.error">
                        <ErrorMessage />
                    </template>

                    <template x-if="$store.ui.info">
                        <InfoMessage />
                    </template>

                </div>
            </footer>
        </div>
    </div>
</div>

<style>
	/* Header wrapping fix */
	.modal-card-head {
		align-items: flex-start;
	}

	.modal-card-head .modal-card-title {
		flex: 1 1 0;
		min-width: 0;
		white-space: normal;
	}

	/* A — Footer reserved space */
	.modal-card-foot .is-fullwidth {
		flex: 1 1 100%;
	}

	/* B — Align-bottom utility */
	.align-bottom {
		display: flex;
		align-items: flex-end;
	}

	/* C — Modal max-height for mobile */
	.modal .modal-card {
		max-height: calc(100vh - 7rem);
		overflow-y: auto;
	}

	/* Label alignment */
	.field-label {
		flex-basis: 4rem;
	}

	/* Top-align modal */
	.modal.modal-top .modal-card {
		margin-top: 1.5rem;
		margin-bottom: auto;
	}

</style>
