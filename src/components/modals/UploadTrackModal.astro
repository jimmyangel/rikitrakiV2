---
import '../../styles/vendor/bulma-switch-control/main.min.css'
import ErrorMessage from '../widgets/ErrorMessage.astro'
import InfoMessage from '../widgets/InfoMessage.astro'
import { Icon } from 'astro-icon/components'
---

<div x-data>
	<div class="modal modal-top" :class="{ 'is-active': $store.ui.showUploadTrackModal }">

        <div class="modal-background"
             @click="$store.ui.showUploadTrackModal = false"></div>

        <div class="modal-card upload-track-modal-card" x-data="uploadTrackModal">

            <!-- HEADER -->
            <header class="modal-card-head">
                <div class="modal-card-title">
                    <p class="is-size-5 mb-2">Upload a Track</p>
                    <p class="is-size-6 mr-2">
                        Provide track information and optional photos…
                    </p>
                </div>
                <button class="delete" aria-label="close"
                        @click="$store.ui.showUploadTrackModal = false"></button>
            </header>

            <!-- BODY -->
            <section class="modal-card-body">

                <!-- TABS -->
                <div class="tabs is-boxed">
                    <ul>
                        <li :class="{ 'is-active': tab === 'info' }">
                            <a @click="tab = 'info'">Info</a>
                        </li>
						<li x-show="trackGPXBlob"
							:class="{ 'is-active': tab === 'photos' }">
							<a @click="tab = 'photos'">Photos</a>
						</li>
                    </ul>
                </div>

				<!-- INFO TAB -->
				<div x-show="tab === 'info'">
					<div>

						<!-- GPX FILE -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">GPX file</label>
							<div class="field-body">
								<div class="field">
									<div class="control">
										<input class="input"
											type="file"
											accept=".gpx"
											x-ref="gpxInput"
											@change="selectGpxFile($event)"
											:class="{ 'is-danger': errorField === 'gpxFile' }">
									</div>
									<p class="help is-size-7">Up to 4MB</p>

									<template x-if="trackRegionTags">
										<p class="help mt-1">
											Detected region:
											<span x-text="trackRegionTags.join(', ')"></span>
										</p>
									</template>
								</div>
							</div>
						</div>

						<!-- TRACK NAME -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Name</label>
							<div class="field-body">
								<div class="field">
									<div class="control">
										<input class="input"
											type="text"
											maxlength="200"
											placeholder="Track name"
											x-model="trackName"
											:class="{ 'is-danger': errorField === 'trackName' }">
									</div>
								</div>
							</div>
						</div>

						<!-- DESCRIPTION -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Description</label>
							<div class="field-body">
								<div class="field">
									<div class="control">
										<textarea class="textarea"
												rows="5"
												maxlength="5000"
												placeholder="Track description"
												x-model="trackDescription"
												:class="{ 'is-danger': errorField === 'trackDescription' }"></textarea>
									</div>
								</div>
							</div>
						</div>

						<!-- FAVORITE -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Favorite?</label>
							<div class="field-body">
								<div class="field">
									<label class="switch is-rounded">
										<input type="checkbox" x-model="trackFav">
										<span class="check is-info"></span>
									</label>
								</div>
							</div>
						</div>

						<!-- DIFFICULTY -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Difficulty</label>
							<div class="field-body">
								<div class="field">
									<div class="buttons has-addons">
										<button
											class="button"
											:class="{ 'has-background-grey-light is-selected': trackLevel === 'Easy' }"
											@click="trackLevel = 'Easy'">
											Easy
										</button>

										<button
											class="button"
											:class="{ 'has-background-grey-light is-selected': trackLevel === 'Moderate' }"
											@click="trackLevel = 'Moderate'">
											Moderate
										</button>

										<button
											class="button"
											:class="{ 'has-background-grey-light is-selected': trackLevel === 'Difficult' }"
											@click="trackLevel = 'Difficult'">
											Difficult
										</button>
									</div>
								</div>
							</div>
						</div>

						<!-- ACTIVITY -->
						<div class="field is-horizontal">
							<label class="field-label is-normal">Activity</label>
							<div class="field-body">
								<div class="field">
									<div class="control">
										<div class="select">
											<select x-model="trackType">
												<option>Hiking</option>
												<option>Biking</option>
												<option>Boating</option>
												<option>Offroad</option>
												<option>Motorcycling</option>
												<option>Flying</option>
												<option>Skiing</option>
												<option>Snowshoeing</option>
												<option>Getting There</option>
											</select>
										</div>
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>

                <!-- PHOTOS TAB -->
				<div x-show="tab === 'photos' && trackGPXBlob">
					<div>

						<!-- PHOTO UPLOAD ROW -->
						<div class="field">
							<div class="control is-flex is-flex-wrap-wrap is-align-items-center">

								<p class="mr-3 mb-2">Up to 8 JPEG images</p>

								<div class="mr-4 mb-2">
									<input type="file"
										multiple
										accept="image/jpeg"
										class="is-hidden"
										x-ref="photoInput"
										@change="selectPhotos($event)">
									<button class="button" @click="$refs.photoInput.click()">
										<Icon name="fa7-solid:image" class="is-size-4"/>
									</button>
								</div>

								<p class="mr-4 mb-2">Images larger than 1MB will be resized</p>

								<div class="is-flex is-align-items-center mb-2">
									<label class="label mr-2 mb-0">Time offset (hrs)</label>
									<input class="input"
										style="width: 6rem;"
										type="number"
										min="-14"
										max="14"
										step="0.5"
										x-model="timeOffset">
								</div>

							</div>
						</div>

						<!-- PHOTO GRID -->
						<div class="columns is-multiline" id="track-photos-container">
							<template x-for="(photo, idx) in trackPhotos" :key="idx">
								<div class="column
											is-full-mobile
											is-half-tablet
											is-one-third-desktop
											is-one-quarter-widescreen"
									draggable="true"
									@dragstart="startDrag(idx)"
									@dragover.prevent
									@drop="dropOn(idx)">

									<input class="input is-small mb-1"
										type="text"
										maxlength="200"
										placeholder="Caption"
										x-model="photo.picCaption">

									<figure class="image is-4by3 mb-1 photo-figure"
											:class="({'geo-exif': photoMeta[idx].hasExifGps,'geo-interp': !photoMeta[idx].hasExifGps && trackPhotos[idx].picLatLng, 'geo-none': !photoMeta[idx].hasExifGps && !trackPhotos[idx].picLatLng})">
										<button
											class="delete photo-delete-btn"
											@click="deletePhoto(idx)"
											title="Remove photo"
										></button>

										<img :src="photoMeta[idx].preview"
											style="width:100%; height:100%; object-fit:cover;">
									</figure>

								</div>
							</template>
						</div>

						<!-- LEGEND (dynamic) -->
						<div class="photo-legend is-size-7 mt-3"
							x-show="trackPhotos.length > 0 && (
										trackPhotos.some((p, i) => photoMeta[i].hasExifGps) ||
										trackPhotos.some((p, i) => !photoMeta[i].hasExifGps && p.picLatLng)
									)">

							<span class="legend-item"
								x-show="trackPhotos.some((p, i) => photoMeta[i].hasExifGps)">
								<span class="legend-box geo-exif"></span>
								Geotagged (EXIF)
							</span>

							<span class="legend-item"
								x-show="trackPhotos.some((p, i) => !photoMeta[i].hasExifGps && p.picLatLng)">
								<span class="legend-box geo-interp"></span>
								Time‑tagged (interpolated)
							</span>

						</div>

					</div>
				</div>

				<div class="field is-horizontal mt-4">
					<div class="field-label"></div>
					<div class="field-body">
						<div class="field">
							<div class="control">
								<button class="button"
										:disabled="$store.ui.uploading"
										@click="upload()">
									Upload
								</button>
							</div>
						</div>
					</div>
				</div>

            </section>

            <!-- FOOTER -->
            <footer class="modal-card-foot py-2">
                <div class="is-fullwidth" style="height: 68px;">

                    <template x-if="$store.ui.error">
                        <ErrorMessage />
                    </template>

                    <template x-if="$store.ui.info">
                        <InfoMessage />
                    </template>

                </div>
            </footer>
        </div>
    </div>
</div>

<style>
    /* Header wrapping fix */
    .modal-card-head {
        align-items: flex-start;
    }

    .modal-card-head .modal-card-title {
        flex: 1 1 0;
        min-width: 0;
        white-space: normal;
    }

    /* A — Footer reserved space */
    .modal-card-foot .is-fullwidth {
        flex: 1 1 100%;
    }

    /* B — Align-bottom utility */
    .align-bottom {
        display: flex;
        align-items: flex-end;
    }

    /* C — Modal max-height for mobile */
    .modal .modal-card {
        max-height: calc(100vh - 7rem);
        overflow-y: auto;
    }

    /* Label alignment */
    .field-label {
        flex-basis: 4rem;
    }

    /* Top-align modal */
    .modal.modal-top .modal-card {
        margin-top: 1.5rem;
        margin-bottom: auto;
    }

    /* Default: mobile (1 per row) */
    .upload-track-modal-card {
        width: 90vw !important;
        max-width: 90vw !important;
    }

    /* ≥ 768px: wider modal */
    @media screen and (min-width: 768px) {
        .upload-track-modal-card {
            width: 60rem !important;
            max-width: 90vw !important;
        }
    }

    /* ≥ 1024px: widest modal */
    @media screen and (min-width: 1024px) {
        .upload-track-modal-card {
            width: 60rem !important;
            max-width: 90vw !important;
        }
    }

	/* Reduce column gap inside the upload modal */
	.upload-track-modal-card .columns {
		--bulma-column-gap: 0.3rem;
	}

	/* Make the figure the positioning container */
	.photo-figure {
		position: relative;
		overflow: hidden; /* keep image clipped, not the button */
	}

	/* Position Bulma delete button in top-right */
	.photo-delete-btn {
		position: absolute;
		top: 0.35rem;
		right: 0.35rem;
		z-index: 10;        /* <-- THIS is the key */
		transform: scale(0.8);
		cursor: pointer;
	}

	/* Geotagging feedback borders */
	.geo-exif {
		border: 2px solid #2ecc71; /* green */
	}

	.geo-interp {
		border: 2px solid #f39c12; /* orange */
	}

	.geo-none {
		border: 2px solid transparent;
	}

	.photo-legend {
		display: flex;
		gap: 1.5rem;
		align-items: center;
		color: #666;
	}

	.legend-item {
		display: flex;
		align-items: center;
		gap: 0.4rem;
	}

	.legend-box {
		width: 14px;
		height: 14px;
		border: 3px solid transparent;
		display: inline-block;
		flex-shrink: 0;
		border-radius: 2px;
	}

	.legend-box.geo-exif {
		border-color: #2ecc71; /* green */
	}

	.legend-box.geo-interp {
		border-color: #f39c12; /* orange */
	}

</style>


