---
import BaseLayout from '../layouts/BaseLayout.astro'
import SidePanel from '../components/SidePanel.astro'
import MapPanel from '../components/MapPanel.astro'
import { Icon } from 'astro-icon/components'
import '../styles/map-frame.css'
---

<BaseLayout>
    <section class="main-layout">
        <div class="map-frame">

            <!-- SIDE PANEL -->
            <aside class="side-panel map-frame-side isopen">
                <div class="side-panel-content isopen">
                    <button class="side-panel-close-button" title="Close panel">
                        <Icon name="fa7-solid:xmark" class="icon" />
                    </button>

                    <SidePanel />
                </div>
            </aside>

            <!-- SIDE PANEL OPEN BUTTON -->
            <button id="toggleSidePanel" class="side-panel-open-button hidden" title="Open panel">
                <Icon name="fa7-solid:right-from-bracket" class="icon icon-desktop" />
                <Icon name="fa7-solid:caret-down" class="icon icon-mobile" />
            </button>

            <!-- MAP COLUMN -->
            <div class="map-frame-main">

                <div class="map-grid">
                    <div class="map-grid-map map-touch-wrapper" style="position: relative;">
                        <MapPanel />
                        <div class="map-touch-overlay"></div>
                        <div class="map-interact-hint">Tap to interact</div>
                    </div>

                    <!-- BOTTOM PANEL -->
                    <div class="bottom-panel isopen">
                        <button class="bottom-panel-close-button" title="Close info panel">
                            <Icon name="fa7-solid:xmark" class="icon" />
                        </button>

                        <div class="bottom-panel-content">
                            HEY
                        </div>
                    </div>

                    <!-- BOTTOM PANEL OPEN BUTTON -->
                    <button id="toggleBottomPanel" class="bottom-panel-open-button" title="Open info panel">
                        <Icon name="fa7-solid:caret-up" class="icon" />
                    </button>
                </div>
            </div>

        </div>
    </section>
</BaseLayout>

<script>
    import * as mapFrame from '../scripts/ui/mapFrame.js'
    import * as map from '../scripts/mapper/map.js'
    import { getTrackInfo } from '../scripts/data/getTrackInfo'
    import { getTracksByLoc } from '../scripts/data/getTracksByLoc'

    document.addEventListener('alpine:init', () => {
        Alpine.store('tracks', {
            all: [],
            selected: null,
            loadingTracks: false,
            loadingCesium: false,
            get loading() { return this.loadingTracks || this.loadingCesium },

            selectTrack(track) {
                this.selected = track
            },

            clear() {
                this.selected = null
            }
        })
    })

    document.addEventListener('DOMContentLoaded', async () => {
        mapFrame.initUI()
        map.initMap()

        const lat = 45.5152
        const lon = -122.6784

        Alpine.store('tracks').loadingTracks = true
        const { tracks } = await getTracksByLoc(lat, lon, 200)
        Alpine.store('tracks').loadingTracks = false

        Alpine.store('tracks').all = tracks
        map.setTracks(tracks)
    })
</script>

<style>
/* main-layout fills app-root */
.main-layout {
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* DESKTOP */
@media (min-width: 769px) {
    .map-frame {
        display: flex;
        flex-direction: row;
        height: 100%;
        width: 100%;
    }

    .map-frame-side {
        width: 20rem;
        flex: none;
        height: 100%;
    }

    .map-frame-main {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-width: 0;
        min-height: 0;
        position: relative;
    }
}

/* MOBILE */
@media (max-width: 768px) {
    .map-frame {
        display: block;
        width: 100%;
        height: 100%;
    }

    .map-frame-side {
        width: 100%;
        height: auto;
    }

    .map-frame-main {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 0;
        position: relative;
    }
}

/* Bottom panel open button */
.bottom-panel-open-button {
    position: absolute;
    right: 1rem;
    bottom: 1rem;
    z-index: 20;
}

/* Touch overlay */
@media (max-width: 768px) {
    .map-touch-wrapper {
        position: relative;
    }

    .map-touch-overlay {
        position: absolute;
        inset: 0;
        pointer-events: auto;
        background: transparent;
    }

    .map-touch-wrapper.map-active .map-touch-overlay {
        pointer-events: none;
    }

    .map-interact-hint {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.55);
        color: #000;
        font-size: 12px;
        border-radius: 6px;
        pointer-events: auto;
        opacity: 1;
        transition: opacity 0.25s ease-out;
        backdrop-filter: blur(6px);
    }

    .map-touch-wrapper.map-active .map-interact-hint {
        opacity: 0;
    }
}
</style>
