---
import BaseLayout from '../layouts/BaseLayout.astro'
import SidePanel from '../components/panels/SidePanel.astro'
import MapPanel from '../components/panels/MapPanel/MapPanel.astro'
import BottomPanel from '../components/panels/BottomPanel/BottomPanel.astro'
import SearchCenterModal from '../components/modals/SearchCenterModal.astro'
import LoginModal from '../components/modals/LoginModal.astro'
import { Icon } from 'astro-icon/components'
import '../styles/map-frame.css'
---

<BaseLayout>
    <section class="main-layout">
        <div class="map-frame">

            <!-- SIDE PANEL -->
            <aside class="side-panel map-frame-side isopen">
                <div class="side-panel-content isopen">
                    <button class="side-panel-close-button" title="Close panel">
                        <Icon name="fa7-solid:xmark" class="icon" />
                    </button>

                    <SidePanel />
                </div>
            </aside>

            <!-- SIDE PANEL OPEN BUTTON -->
            <button id="toggleSidePanel" class="side-panel-open-button hidden" title="Open panel">
                <Icon name="fa7-solid:right-from-bracket" class="icon icon-desktop" />
                <Icon name="fa7-solid:caret-down" class="icon icon-mobile" />
            </button>

            <!-- MAP COLUMN -->
            <div class="map-frame-main">

                <div class="map-grid">
					<!-- MAP PANEL -->
                    <div class="map-grid-map map-touch-wrapper">
                        <MapPanel />
                        <div class="map-touch-overlay"></div>
                        <div class="map-interact-hint">Tap to interact</div>
                    </div>

					 <!-- BOTTOM PANEL -->
					<BottomPanel />	

                    <!-- BOTTOM PANEL OPEN BUTTON -->
                    <button id="toggleBottomPanel" class="bottom-panel-open-button" title="Open info panel">
                        <Icon name="fa7-solid:caret-up" class="icon" />
                    </button>
                </div>
            </div>

        </div>
    </section>
</BaseLayout>

<div>
    <SearchCenterModal />
    <LoginModal />
</div>

<script>
    import * as mapFrame from '../scripts/ui/mapFrame.js'
    import * as map from '../scripts/mapper/map.js'
    import { getApproxLocation } from '../scripts/utils/geoUtils.js'
    import initTracksStore from '../scripts/stores/tracks.js'
    import initUserStore from '../scripts/stores/user.js'
    import descWidth from '../scripts/alpine-plugins/formatting.js'
    import { isIOS, isChromeOniPad } from '../scripts/utils/env'
    import { constants } from '../scripts/config'
    import { sanitizeUrl } from '../scripts/utils/sanitizeUrl'

    // Read initial trackId from URL
    import { initFromUrl } from '../scripts/utils/history.js'

    document.addEventListener('alpine:init', () => {
        Alpine.plugin(descWidth)
        initTracksStore(Alpine)
        initUserStore(Alpine)

        Alpine.store('ui', {
            showSearchCenterModal: false,
            showLoginModal: false
        })
    })

    document.addEventListener('DOMContentLoaded', async () => {
        mapFrame.initUI()
        map.initMap()

        const tracks = Alpine.store('tracks') as any
        tracks.loadingCesium = true

        ;(window as any).map = {
            whenViewerReady: map.whenViewerReady,
            showMapThumbnails: map.showMapThumbnails,
            hideMapThumbnails: map.hideMapThumbnails,
            renderMapThumbnails: map.renderMapThumbnails,
            clearMapThumbnails: map.clearMapThumbnails
        }

        tracks.loadingCesium = false

        ;(window as any).env = {
            isIOS,
            isChromeOniPad
        }

        ;(window as any).constants = constants

        const { lat: urlLat, lon: urlLon } = sanitizeUrl()

        let initialLat: number
        let initialLon: number

        if (urlLat !== null && urlLon !== null) {
            initialLat = urlLat
            initialLon = urlLon
        } else {
            const approx = await getApproxLocation()
            initialLat = approx.lat
            initialLon = approx.lon
            tracks.countryCode = approx.countryCode
        }

        tracks.defaultLat = initialLat
        tracks.defaultLon = initialLon

        await tracks.setSearchCenter(initialLat, initialLon, { fromInit: true })


        await map.whenViewerReady()

        const { trackId } = initFromUrl()

        if (trackId) {
            await tracks.openTrack(trackId, { fromInit: true })
            history.replaceState({ trackId }, '')
        } else {
            history.replaceState(
                { trackId: null, center: { lat: initialLat, lon: initialLon } },
                ''
            )
        }

        window.addEventListener('popstate', async e => {
            const state = e.state
            const tracks = Alpine.store('tracks') as any

            if (state?.trackId) {
                await tracks.openTrack(state.trackId, { fromHistory: true })
                return
            }

            if (tracks.activeTrackId) {
                tracks.exitActiveTrack({ fromHistory: true }) 
            }

            if (state?.center) {
                await tracks.setSearchCenter(
                    state.center.lat,
                    state.center.lon,
                    { fromHistory: true }
                )
                return
            }

            await tracks.setSearchCenter(
                tracks.defaultLat,
                tracks.defaultLon,
                { fromHistory: true }
            )
        })
    })

</script>

<script src="/src/scripts/vendor/glightbox.js"></script>


