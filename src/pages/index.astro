---
import BaseLayout from '../layouts/BaseLayout.astro'
import SidePanel from '../components/SidePanel.astro'
import MapPanel from '../components/MapPanel.astro'
import { Icon } from 'astro-icon/components'
import '../styles/map-frame.css'
---

<BaseLayout>
    <section class="main-layout">
        <div class="map-frame">

            <!-- SIDE PANEL -->
            <aside class="side-panel map-frame-side isopen">
                <div class="side-panel-content isopen">
                    <button class="side-panel-close-button" title="Close panel">
                        <Icon name="fa7-solid:xmark" class="icon" />
                    </button>

                    <SidePanel />
                </div>
            </aside>

            <!-- SIDE PANEL OPEN BUTTON -->
            <button id="toggleSidePanel" class="side-panel-open-button hidden" title="Open panel">
                <Icon name="fa7-solid:right-from-bracket" class="icon icon-desktop" />
                <Icon name="fa7-solid:caret-down" class="icon icon-mobile" />
            </button>

            <!-- MAP COLUMN -->
            <div class="map-frame-main">

                <div class="map-grid">
                    <div class="map-grid-map map-touch-wrapper">
                        <MapPanel />
                        <div class="map-touch-overlay"></div>
                        <div class="map-interact-hint">Tap to interact</div>
                    </div>

                    <!-- BOTTOM PANEL -->
                    <div class="bottom-panel isopen">
                        <button class="bottom-panel-close-button" title="Close info panel">
                            <Icon name="fa7-solid:xmark" class="icon" />
                        </button>

                        <div class="bottom-panel-content">
                            HEY
                        </div>
                    </div>

                    <!-- BOTTOM PANEL OPEN BUTTON -->
                    <button id="toggleBottomPanel" class="bottom-panel-open-button" title="Open info panel">
                        <Icon name="fa7-solid:caret-up" class="icon" />
                    </button>
                </div>
            </div>

        </div>
    </section>
</BaseLayout>

<script>
    import * as mapFrame from '../scripts/ui/mapFrame.js'
    import * as map from '../scripts/mapper/map.js'
    import { getTrackInfo } from '../scripts/data/getTrackInfo'
    import { getTracksByLoc } from '../scripts/data/getTracksByLoc'
	import { getApproxLocation } from '../scripts/utils/geoUtils.js'

	document.addEventListener('alpine:init', () => {
		Alpine.store('tracks', {
			all: [],
			selected: null,
			loadingTracks: false,
			loadingCesium: false,

			lat: null,
			lon: null,
			countryCode: 'US',   // new
			radiusKm: null,
			count: null,

			get loading() {
				return this.loadingTracks || this.loadingCesium
			},

			// --- Derived state for units ---
			get distanceUnit() {
				return this.countryCode === 'US' ? 'mi' : 'km'
			},

			get radiusDisplay() {
				if (this.radiusKm == null) return null
				return this.countryCode === 'US'
					? Math.round(this.radiusKm * 0.621371)
					: this.radiusKm
			},

			selectTrack(track) {
				this.selected = track
			},

			clear() {
				this.selected = null
			}
		})
	})


	document.addEventListener('DOMContentLoaded', async () => {
		mapFrame.initUI()
		map.initMap()

		const { lat, lon } = await getApproxLocation()

		map.setSearchCenter(lat, lon)

		Alpine.store('tracks').lat = lat
		Alpine.store('tracks').lon = lon

		Alpine.store('tracks').loadingTracks = true
		const { tracks, radiusKm, count } = await getTracksByLoc(lat, lon, 200)
		Alpine.store('tracks').loadingTracks = false

		Alpine.store('tracks').all = tracks
		Alpine.store('tracks').radiusKm = radiusKm
		Alpine.store('tracks').count = count

		map.setTracks(tracks)
	})

</script>

